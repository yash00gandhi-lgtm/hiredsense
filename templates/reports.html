{% extends "base.html" %}
{% block title %}Reports • HiredSense{% endblock %}

{% block topbar_actions %}
  <button id="hsReportsExportBtn" class="hs-btn hs-btn-ghost" disabled style="opacity:.6;">Export CSV</button>
{% endblock %}

{% block content %}

<div class="hs-card mb-4">
  <div class="hs-card-h">
    <div>
      <h1 class="hs-title" style="font-size:1.8rem;">Reports</h1>
      <div class="hs-sub">Job-wise top candidates report.</div>
    </div>
  </div>

  <div class="p-3 p-md-4">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-6">
        <label class="hs-label">Select Job</label>
        <select id="hsReportJobSelect" class="form-select">
          <option value="">— Select a job —</option>
        </select>
      </div>

      <div class="col-12 col-md-2">
        <label class="hs-label">Min Score</label>
        <input id="hsReportMinScore" type="number" class="form-control" placeholder="e.g. 60" min="0" max="100" step="1">
      </div>

      <div class="col-12 col-md-2">
        <label class="hs-label">Top N</label>
        <select id="hsReportLimit" class="form-select">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>

      <div class="col-12 col-md-8">
        <label class="hs-label">Must-have skills (comma separated)</label>
        <input id="hsReportMustHave" type="text" class="form-control" placeholder="e.g. django, drf, mysql">
      </div>

      <div class="col-12 col-md-4 d-grid">
        <button id="hsReportLoadBtn" class="hs-btn hs-btn-primary">Load Report</button>
      </div>
    </div>

    <div class="mt-3 text-muted small" id="hsReportMeta"></div>
  </div>
</div>

<div class="hs-card">
  <div class="hs-card-h">
    <div>
      <h2 class="hs-title" style="font-size:1.35rem;">Top Candidates</h2>
      <div class="hs-sub">Sorted by score (highest first).</div>
    </div>
  </div>

  <div class="p-3 p-md-4">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr class="text-muted" style="font-weight:800;">
            <th>Resume</th>
            <th>User</th>
            <th>Score</th>
            <th>ATS</th>
            <th>Missing</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="hsReportBody"></tbody>
      </table>
      <div id="hsReportState" class="py-4 text-center text-muted small" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const esc = (s="") =>
    String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

  const qs = (id) => document.getElementById(id);

  const sel = qs("hsReportJobSelect");
  const minEl = qs("hsReportMinScore");
  const mustEl = qs("hsReportMustHave");
  const limitEl = qs("hsReportLimit");

  const loadBtn = qs("hsReportLoadBtn");
  const meta = qs("hsReportMeta");
  const body = qs("hsReportBody");
  const state = qs("hsReportState");
  const exportBtn = qs("hsReportsExportBtn");

  function setState(msg, show=true){
    if (!state) return;
    state.style.display = show ? "block" : "none";
    state.textContent = msg || "";
  }

  async function fetchJson(url){
    const res = await fetch(url, { credentials: "same-origin" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  function currentJobId(){
    return (sel && sel.value) ? sel.value : "";
  }

  function syncExport(){
    const jobId = currentJobId();
    exportBtn.disabled = !jobId;
    exportBtn.style.opacity = exportBtn.disabled ? ".6" : "1";
  }

  function buildParams(){
    const params = new URLSearchParams();
    params.set("ordering", "-score");

    const min = (minEl?.value || "").trim();
    const must = (mustEl?.value || "").trim();
    const limit = (limitEl?.value || "").trim();

    if (min) params.set("min_score", min);
    if (must) params.set("must_have", must);
    if (limit) params.set("limit", limit);

    return params;
  }

  // Load jobs into select
  try{
    const data = await fetchJson("/api/jobs/?page=1&ordering=-created_at");
    const jobs = Array.isArray(data.results) ? data.results : (data.results?.results ?? []);
    sel.innerHTML =
      `<option value="">— Select a job —</option>` +
      jobs.map(j => `<option value="${j.id}">${esc(j.title || ("Job #" + j.id))}</option>`).join("");
  } catch(e){
    meta.textContent = "Failed to load jobs list.";
  }

  syncExport();

  // Auto load on change (job / filters / limit)
  sel.addEventListener("change", () => {
    syncExport();
    if (currentJobId()) loadReport();
  });
  minEl?.addEventListener("input", () => { if (currentJobId()) loadReport(); });
  mustEl?.addEventListener("input", () => { if (currentJobId()) loadReport(); });
  limitEl?.addEventListener("change", () => { if (currentJobId()) loadReport(); });

  async function loadReport(){
    const jobId = currentJobId();
    if (!jobId) { alert("Select a job first."); return; }

    body.innerHTML = "";
    setState("Loading…", true);

    const params = buildParams();

    try{
      const data = await fetchJson(`/api/jobs/${jobId}/matches/?${params.toString()}`);
      const rows = Array.isArray(data.results?.results)
        ? data.results.results
        : (Array.isArray(data.results) ? data.results : []);

      if (!rows.length){
        body.innerHTML = "";
        setState("No matches found.", true);
        meta.textContent = "";
        return;
      }

      setState("", false);
      meta.textContent = `Showing top ${rows.length} candidates for Job #${jobId}`;

      body.innerHTML = rows.map(r => {
        const missing = Array.isArray(r.missing_skills) ? r.missing_skills.join(", ") : (r.missing_skills || "-");
        return `
          <tr>
            <td class="fw-semibold">${esc(r.resume_title || "-")}</td>
            <td>${esc(r.username || "-")}</td>
            <td><strong>${esc(String(r.score ?? "-"))}</strong></td>
            <td>${esc(String(r.ats_score ?? "-"))}</td>
            <td class="text-muted">${esc(missing)}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary"
                 href="/api/resumes-ui/?resume_id=${encodeURIComponent(r.resume_id)}"
                 target="_blank" rel="noopener">Open</a>
            </td>
          </tr>
        `;
      }).join("");
    } catch(e){
      body.innerHTML = "";
      setState("Failed to load report.", true);
      console.error(e);
    }
  }

  loadBtn.addEventListener("click", loadReport);

  exportBtn.addEventListener("click", () => {
    const jobId = currentJobId();
    if (!jobId) return;

    const params = buildParams();
    // ordering not needed for export
    params.delete("ordering");

    window.location.href = `/api/jobs/${jobId}/matches-export/?${params.toString()}`;
  });
});
</script>

{% endblock %}
